@startuml JB_API_Class_Diagram

!theme aws-orange
skinparam backgroundColor #f8f9fa
skinparam classAttributeIconSize 0
skinparam classFontStyle bold
skinparam classFontSize 11
skinparam packageFontSize 14
skinparam packageFontStyle bold
skinparam packageBackgroundColor #e3f2fd
skinparam packageBorderColor #1976d2
skinparam classBorderColor #424242
skinparam classBackgroundColor #ffffff
skinparam classHeaderBackgroundColor #e8f5e8
skinparam arrowColor #666666
skinparam arrowFontSize 10
skinparam linetype ortho
skinparam nodesep 50
skinparam ranksep 80

package "üèóÔ∏è Core State" <<Rectangle>> {
    class InnerState <<Entity>> {
        - sdk_config: SdkConfig
        - bedrockagent: BedrockClient
        - dynamo: DynamoClient
        - cognito: CognitoClient
    }
}

package "üîê Authentication" <<Rectangle>> {
    class AuthorizedUser<E> <<Service>> {
        - sub: Sub
        - _extra: E
        --
        + sub(): &str
    }
    
    class Sub <<ValueObject>> {
        - value: String
    }
    
    class AssertAdmin <<Marker>> {
    }
    
    AuthorizedUser *-- Sub : contains
    AuthorizedUser o-- AssertAdmin : can contain
}

package "üíæ Database Models" <<Database>> {
    class Counter <<Entity>> {
        + name: String
        + count: u64
        --
        {static} + TABLE: &str
        {static} + PARTITION: &str
        --
        + increment(): ApiResult<u64>
    }
    
    class LevelID <<ValueObject>> {
        + id: u64
    }
    
    class Level <<Aggregate>> {
        + level_id: LevelID
        + name: String
        + prompt_components: Vec<PromptComponent>
        + next: Vec<LevelID>
        --
        {static} + TABLE: &str
    }
    
    class TemplateID <<ValueObject>> {
        + id: String
        --
        + default(): Self
    }
    
    class ComponentID <<ValueObject>> {
        + id: u64
    }
    
    class PromptComponent <<Entity>> {
        + component_id: ComponentID
        + template_id: TemplateID
        + ordering: String
        + text: String
        --
        {static} + TABLE: &str
        --
        + create_sort_key(): Result<String>
        - create_sort_key_between(): String
    }
    
    Level *-- LevelID : id
    Level *-- "*" PromptComponent : components
    Level --> "*" LevelID : next
    PromptComponent *-- ComponentID : id
    PromptComponent *-- TemplateID : template
}

package "üåê API Models" <<Cloud>> {
    
    package "Component API" {
        class Component <<DTO>> {
            + id: ComponentID
            + text: String
        }
        
        class GetComponentsResponse <<Response>> {
            + components: Vec<Component>
        }
        
        class AddComponentRequest <<Request>> {
            + predecessor: Option<ComponentID>
        }
        
        class AddComponentResponse <<Response>> {
            + component_id: ComponentID
        }
        
        class ModifyComponentRequest <<Request>> {
            + new_text: String
        }
        
        class MoveComponentRequest <<Request>> {
            + predecessor: Option<ComponentID>
        }
    }
    
    package "Level API" {
        class LevelDTO <<DTO>> {
            + id: LevelID
            + name: String
            + next: Vec<LevelID>
        }
        
        class GetLevelsResponse <<Response>> {
            + levels: Vec<LevelDTO>
        }
        
        class CreateLevelRequest <<Request>> {
            + name: String
        }
        
        class CreateLevelResponse <<Response>> {
            + level: Level
        }
        
        class ModifyLevelRequest <<Request>> {
            + name: Option<String>
            + prompt_components: Option<Vec<ComponentID>>
            + next: Option<Vec<LevelID>>
        }
    }
    
    package "Chat API" {
        class ChatRequest <<Request>> {
            + message: String
        }
        
        class ChatReply <<Response>> {
            + reply: String
        }
    }
    
    Component --> ComponentID
    GetComponentsResponse --> "*" Component
    AddComponentRequest ..> ComponentID
    AddComponentResponse --> ComponentID
    MoveComponentRequest ..> ComponentID
    LevelDTO --> LevelID
    LevelDTO --> "*" LevelID : next
    GetLevelsResponse --> "*" LevelDTO
    CreateLevelResponse --> Level
    ModifyLevelRequest ..> "*" ComponentID
    ModifyLevelRequest ..> "*" LevelID
}

package "‚ö†Ô∏è Error Handling" <<Node>> {
    
    package "Auth Errors" {
        enum AuthorizationError <<Exception>> {
            NotAuthorized
            NotAnAdmin
            AdminAssertion
        }
    }
    
    package "Database Errors" {
        enum CounterError <<Exception>> {
            CounterIncrementFailed
        }
        
        enum ComponentError <<Exception>> {
            QueryComponents
            PredecessorDoesNotExist
            ComponentCreation
            DoesNotExist
            UpdateComponent
            ComponentDeletion
            QueryAdjacent
            UpdatePosition
        }
        
        enum LevelError <<Exception>> {
            QueryLevels
            LevelCreation
            DoesNotExist
            LevelModification
            LevelDeletion
        }
    }
    
    package "Service Errors" {
        enum ChatError <<Exception>> {
            BedrockInvocationFailed
            IllegalModelResponse
        }
    }
}

' Relationships
InnerState --> "uses" Counter
InnerState --> "uses" Level
InnerState --> "uses" PromptComponent

@enduml